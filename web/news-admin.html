<!doctype html>
<!--
  =========================================================
  news-admin.html  (LOCAL HELPER — MANAGE NEWS DATA)
  ---------------------------------------------------------
  PURPOSE
  • Edit and export the two JSON files used by news.html:
      - /data/posts.json
      - /data/newsletters.json
  • Safer, friendlier authoring with draft/pinned toggles,
    Markdown option + live preview, basic validation, and
    ID-collision protection (auto suffix -2, -3, …).

  HOW TO USE
  1) Click “Load … from /data” to fetch your current JSON (same-origin),
     OR use the file pickers to import local JSON files.
  2) Add or edit posts/newsletters.
  3) Click “Download …” to save updated JSONs; upload them to /data/.

  NOTES
  • Designed to run locally (no server needed).
  • No external libraries, works offline.
  • Keep this page out of your sitemap; it already has noindex.

  =========================================================
-->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Task Karate – News Admin (Local Helper)</title>
  <meta name="robots" content="noindex, nofollow"/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Page styles -->
  <link rel="stylesheet" href="assets/css/news-admin.css">
</head>
<body>
  <div class="container">
    <h1>News Admin (local helper)</h1>

    <div class="card">
      <p>This tool maintains two files used by <code>news.html</code>:</p>
      <ul>
        <li><code>/data/posts.json</code> – blog posts</li>
        <li><code>/data/newsletters.json</code> – PDF archive</li>
      </ul>
      <p><strong>Workflow:</strong> Load your current JSON (buttons below) or import a file, edit, then download and upload to your site’s <code>/data/</code> folder.</p>
    </div>

    <!-- LOAD / IMPORT -->
    <div class="card">
      <h2>Load / Import</h2>
      <div class="inline">
        <button class="btn" id="fetchPosts">Load posts.json from /data</button>
        <input type="file" id="filePosts" accept="application/json"/>
      </div>
      <div class="inline" style="margin-top:8px">
        <button class="btn alt" id="fetchNewsletters">Load newsletters.json from /data</button>
        <input type="file" id="fileNews" accept="application/json"/>
      </div>
    </div>

    <!-- POSTS EDITOR -->
    <div class="card">
      <h2>Blog posts</h2>

      <!-- Post form -->
      <div class="grid2">
        <div>
          <label>Title</label><input id="pTitle" placeholder="Post title"/>
        </div>
        <div>
          <label>Date</label><input id="pDate" type="date"/>
        </div>
      </div>
      <label>Tags (comma-separated)</label><input id="pTags" placeholder="Schedule, Events"/>

      <div class="grid2">
        <div>
          <label>Hero image URL (optional)</label><input id="pHero" placeholder="photos/blog/2025-02-21.jpg"/>
        </div>
        <div>
          <label>Hero image ALT (optional)</label><input id="pHeroAlt" placeholder="Students training in the main dojo"/>
        </div>
      </div>

      <label>Summary (1–2 sentences)</label><input id="pSummary" placeholder="Short blurb shown on the card"/>

      <div class="inline">
        <label class="chk"><input id="pDraft" type="checkbox"> Draft (hide from public)</label>
        <label class="chk"><input id="pPinned" type="checkbox"> Pinned (show at top)</label>
        <label class="chk"><input id="pUseMd" type="checkbox" checked> Body is Markdown (safer)</label>
      </div>

      <div class="grid2">
        <div>
          <label>Body (Markdown or HTML)</label>
          <textarea id="pBody" placeholder="## Heading&#10;Write your update…"></textarea>
        </div>
        <div>
          <label>Live Preview</label>
          <div id="pPreview" class="preview"></div>
        </div>
      </div>

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="addPost">Add / Update Post</button>
        <button class="btn alt" id="dupPost">Duplicate Current</button>
        <small>Tip: Changing title/date changes the ID. If an ID exists, a suffix (-2, -3…) is added.</small>
      </div>

      <!-- Post list -->
      <div class="toolbar">
        <div class="inline">
          <label>Filter by tag</label>
          <input id="postTagFilter" placeholder="e.g., Events"/>
        </div>
      </div>
      <div class="list" id="postList"></div>

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="downloadPosts">Download posts.json</button>
      </div>
    </div>

    <!-- NEWSLETTERS EDITOR -->
    <div class="card">
      <h2>Newsletter archive</h2>
      <div class="grid2">
        <div><label>Year</label><input id="nYear" type="number" min="2000" max="2100"/></div>
        <div><label>Month</label>
          <select id="nMonth">
            <option value="">—</option>
            <option value="1">January</option><option value="2">February</option>
            <option value="3">March</option><option value="4">April</option>
            <option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option>
            <option value="9">September</option><option value="10">October</option>
            <option value="11">November</option><option value="12">December</option>
          </select>
        </div>
      </div>
      <label>PDF file path (relative or absolute)</label><input id="nFile" placeholder="files/newsletters/2025-02.pdf"/>

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="addNews">Add / Update Newsletter</button>
      </div>

      <div class="list" id="newsList"></div>

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="downloadNews">Download newsletters.json</button>
      </div>
    </div>

    <div class="card">
      <h2>Notes</h2>
      <ul>
        <li><strong>Post IDs</strong> = <code>YYYY-MM</code> + slugged title (first ~20 chars). If duplicate, <code>-2</code>, <code>-3</code>, etc.</li>
        <li>Prefer **Markdown** for safety; HTML is allowed but will render as-is.</li>
        <li>Image files: put them in <code>photos/</code> (or full URLs).</li>
        <li>Newsletter file names can be anything; the public page uses whatever’s in the JSON.</li>
      </ul>
    </div>
  </div>

  <script>
  // ------------- Helpers & tiny Markdown -------------
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  function slugify(s){
    return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }
  function escapeHTML(s=''){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function mdToHtml(md=''){
    let t = escapeHTML(md);
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
    t = t.replace(/^###\s?(.*)$/gm, '<h3>$1</h3>');
    t = t.replace(/^##\s?(.*)$/gm,  '<h2>$1</h2>');
    t = t.replace(/^#\s?(.*)$/gm,   '<h1>$1</h1>');
    t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/\*([^*]+)\*/g,    '<em>$1</em>');
    t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    t = t.replace(/(?:^|\n)-(.*?)(?=\n|$)/g, (m, item)=>`<li>${item.trim()}</li>`);
    t = t.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
    t = t.split(/\n{2,}/).map(b=>/^\s*<(h1|h2|h3|ul|li|img|p|blockquote)/.test(b)?b:`<p>${b.replace(/\n/g,'<br>')}</p>`).join('\n');
    return t;
  }

  // ------------- State -------------
  let posts = { schemaVersion: 2, posts: [] };
  let newsletters = { newsletters: [] };

  // ------------- Validation -------------
  function isYYYYMMDD(s){ return /^\d{4}-\d{2}-\d{2}$/.test(s); }
  function validatePosts(){
    const ids = new Set();
    for(const p of posts.posts){
      if(!p.title) return 'Each post needs a title.';
      if(!isYYYYMMDD(p.date)) return `Bad date for "${p.title}" — use YYYY-MM-DD.`;
      if(ids.has(p.id)) return `Duplicate ID: ${p.id}`;
      ids.add(p.id);
      if(p.tags && !Array.isArray(p.tags)) return `Tags must be an array for "${p.title}".`;
    }
    return null;
  }
  function validateNews(){
    for(const n of newsletters.newsletters){
      if(!n.year || !n.month || !n.file) return 'Year, month, and file are required for newsletters.';
      if(n.month < 1 || n.month > 12) return `Bad month: ${n.month}`;
    }
    return null;
  }

  // ------------- Rendering -------------
  function renderPosts(){
    const tagFilter = ($('#postTagFilter').value||'').toLowerCase().trim();
    const list = $('#postList');
    const sorted = posts.posts.slice().sort((a,b)=>a.date<b.date?1:-1);

    const filtered = tagFilter ? sorted.filter(p => (p.tags||[]).some(t => t.toLowerCase().includes(tagFilter))) : sorted;

    list.innerHTML = filtered.map(p=>`
      <div class="item">
        <div class="inline">
          <strong>${p.title}</strong>
          <span>(${p.date})</span>
          <code>#${p.id}</code>
          ${p.draft?'<span class="badge warn">Draft</span>':''}
          ${p.pinned?'<span class="badge">Pinned</span>':''}
        </div>
        <div><small>Tags:</small> ${(p.tags||[]).join(', ')||'—'}</div>
        ${p.hero?`<div><small>Hero:</small> ${p.hero}</div>`:''}
        ${p.summary?`<div><small>Summary:</small> ${escapeHTML(p.summary)}</div>`:''}
        <div class="inline" style="margin-top:6px">
          <button class="btn alt" data-act="edit" data-id="${p.id}">Edit</button>
          <button class="btn warn" data-act="del" data-id="${p.id}">Delete</button>
        </div>
      </div>
    `).join('');

    list.onclick = (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const id = b.dataset.id;
      const act = b.dataset.act;
      const i = posts.posts.findIndex(x=>x.id===id);
      if(i<0) return;
      if(act==='del'){
        if(confirm('Delete this post?')){ posts.posts.splice(i,1); renderPosts(); }
      }else if(act==='edit'){
        const p = posts.posts[i];
        $('#pTitle').value = p.title || '';
        $('#pDate').value = p.date || '';
        $('#pTags').value = (p.tags||[]).join(', ');
        $('#pHero').value = p.hero || '';
        $('#pHeroAlt').value = p.heroAlt || '';
        $('#pSummary').value = p.summary || '';
        $('#pDraft').checked = !!p.draft;
        $('#pPinned').checked = !!p.pinned;
        const useMd = !!p.bodyMd || !p.bodyHtml;
        $('#pUseMd').checked = useMd;
        $('#pBody').value = useMd ? (p.bodyMd||'') : (p.bodyHtml||'');
        window.scrollTo({top:0,behavior:'smooth'});
        updatePreview();
      }
    };
  }

  function renderNews(){
    const list = $('#newsList');
    list.innerHTML = newsletters.newsletters.slice().sort((a,b)=>{
      if(a.year!==b.year) return b.year-a.year;
      return a.month-b.month;
    }).map(n=>`
      <div class="item inline">
        <strong>${n.year}</strong>
        <span>${new Date(2000, n.month-1, 1).toLocaleString(undefined,{month:'long'})}</span>
        <code>${n.file}</code>
        <button class="btn alt" data-year="${n.year}" data-month="${n.month}" data-act="editN">Edit</button>
        <button class="btn warn" data-year="${n.year}" data-month="${n.month}" data-act="delN">Delete</button>
      </div>
    `).join('');

    list.onclick = (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const y = parseInt(b.dataset.year,10);
      const m = parseInt(b.dataset.month,10);
      const act = b.dataset.act;
      const rec = newsletters.newsletters.find(x=>x.year===y && x.month===m);
      if(act==='delN'){
        if(confirm('Delete this newsletter?')){
          newsletters.newsletters = newsletters.newsletters.filter(x=>!(x.year===y && x.month===m));
          renderNews();
        }
      }else if(act==='editN' && rec){
        $('#nYear').value = rec.year;
        $('#nMonth').value = String(rec.month);
        $('#nFile').value = rec.file;
        window.scrollTo({top:0,behavior:'smooth'});
      }
    };
  }

  // ------------- ID creation with collision handling -------------
  function nextUniqueId(date, title){
    const base = date.slice(0,7) + '-' + slugify(title).slice(0,20);
    let id = base, i = 2;
    while(posts.posts.some(p=>p.id===id)){ id = `${base}-${i++}`; }
    return id;
  }

  // ------------- Preview -------------
  function updatePreview(){
    const useMd = $('#pUseMd').checked;
    const html = useMd ? mdToHtml($('#pBody').value) : $('#pBody').value;
    $('#pPreview').innerHTML = html || '<p class="muted">Nothing to preview yet.</p>';
  }
  $('#pBody').addEventListener('input', updatePreview);
  $('#pUseMd').addEventListener('change', updatePreview);

  // ------------- Form actions -------------
  $('#pDate').valueAsDate = new Date();

  $('#addPost').addEventListener('click', ()=>{
    const title = $('#pTitle').value.trim();
    const date  = $('#pDate').value || new Date().toISOString().slice(0,10);
    if(!title){ alert('Title required'); return; }
    if(!isYYYYMMDD(date)){ alert('Use date format YYYY-MM-DD'); return; }

    const tags = $('#pTags').value.split(',').map(s=>s.trim()).filter(Boolean);
    const hero = $('#pHero').value.trim();
    const heroAlt = $('#pHeroAlt').value.trim();
    const summary = $('#pSummary').value.trim();
    const draft = $('#pDraft').checked;
    const pinned = $('#pPinned').checked;
    const useMd = $('#pUseMd').checked;
    const body = $('#pBody').value;

    // Upsert by ID; generate unique ID on first insert
    let id = nextUniqueId(date, title);
    const existingIdx = posts.posts.findIndex(p => p.id.startsWith(date.slice(0,7)) && p.title === title);
    if(existingIdx >= 0) id = posts.posts[existingIdx].id; // editing existing with same title+month

    const rec = {
      id, title, date, tags, hero: hero || undefined, heroAlt: heroAlt || undefined,
      summary: summary || undefined, draft, pinned,
      author: 'Task Karate',
      updatedAt: new Date().toISOString()
    };
    if(useMd) rec.bodyMd = body; else rec.bodyHtml = body;

    const i = posts.posts.findIndex(p=>p.id===id);
    if(i>=0) posts.posts[i] = rec; else posts.posts.push(rec);

    renderPosts();
    alert('Saved in memory. Click "Download posts.json" to export.');
  });

  $('#dupPost').addEventListener('click', ()=>{
    const title = $('#pTitle').value.trim();
    const date  = $('#pDate').value || new Date().toISOString().slice(0,10);
    if(!title){ alert('Fill the form with a post to duplicate first.'); return; }
    const newId = nextUniqueId(date, title + ' copy');
    $('#pTitle').value = title + ' (copy)';
    $('#pBody').dispatchEvent(new Event('input'));
    alert('Fields updated; click "Add / Update Post" to create the duplicate.');
  });

  $('#postTagFilter').addEventListener('input', renderPosts);

  // Newsletters
  $('#addNews').addEventListener('click', ()=>{
    const y = parseInt($('#nYear').value,10);
    const m = parseInt($('#nMonth').value,10);
    const f = $('#nFile').value.trim();
    if(!y || !m || !f){ alert('Year, Month, and File are required'); return; }
    const i = newsletters.newsletters.findIndex(n=>n.year===y && n.month===m);
    const rec = {year:y, month:m, file:f};
    if(i>=0) newsletters.newsletters[i]=rec; else newsletters.newsletters.push(rec);
    renderNews();
  });

  // Download
  function downloadAs(filename, dataObj){
    const errP = validatePosts(); if(filename==='posts.json' && errP){ alert(errP); return; }
    const errN = validateNews();  if(filename==='newsletters.json' && errN){ alert(errN); return; }
    const blob = new Blob([JSON.stringify(dataObj,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  $('#downloadPosts').addEventListener('click', ()=>downloadAs('posts.json', posts));
  $('#downloadNews').addEventListener('click',  ()=>downloadAs('newsletters.json', newsletters));

  // Load existing (same-origin)
  async function fetchJSON(path){
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw 0;
      return await r.json();
    }catch(e){ alert('Could not fetch '+path+' (okay if running locally)'); return null; }
  }
  $('#fetchPosts').addEventListener('click', async()=>{
    const j = await fetchJSON('data/posts.json');
    if(j){ posts = j; renderPosts(); }
  });
  $('#fetchNewsletters').addEventListener('click', async()=>{
    const j = await fetchJSON('data/newsletters.json');
    if(j){ newsletters = j; renderNews(); }
  });

  // Import from files
  $('#filePosts').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    posts = JSON.parse(await f.text());
    renderPosts();
  });
  $('#fileNews').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    newsletters = JSON.parse(await f.text());
    renderNews();
  });

  // Seed defaults
  $('#pPreview').innerHTML = '<p class="muted">Nothing to preview yet.</p>';
  $('#pDate').valueAsDate = new Date();
  renderPosts();
  renderNews();
  </script>
</body>
</html>
