<!doctype html>
<!--
  =========================================================
  news.html  (PUBLIC NEWS + NEWSLETTER ARCHIVE)
  ---------------------------------------------------------
  PURPOSE
  • Public-facing page for blog-style updates and PDF archive.
  • Safer rendering (Markdown preferred), draft/pin controls.
  • Search, tag filters, “load more”, lazy hero images.
  • Remembers filters in the URL (?q=&tags=tag1,tag2).

  QUICK EDITS (WHAT YOU’LL CHANGE MOST)
  1) Content lives in:
     • /data/posts.json          (see schema below)
     • /data/newsletters.json
  2) You can tweak page-only styles in /assets/css/news.css

  POSTS.JSON SCHEMA (v2)
  {
    "schemaVersion": 2,
    "posts": [{
      "id": "2025-02-hi-yah",           // generated from date+title; must be unique
      "title": "Hi-Yah! Winter Testing",
      "date": "2025-02-21",             // YYYY-MM-DD
      "tags": ["Testing","Events"],
      "hero": "photos/blog/2025-02-hero.jpg",
      "heroAlt": "Students practicing kicks",
      "summary": "Testing day, gear checklist, and how to prep.",
      "bodyMd": "## What to know\nBring gear…",  // Prefer Markdown for safety
      // OR: "bodyHtml": "<p>…</p>",               // If you must, but sanitize
      "draft": false,                   // true = hide from public page
      "pinned": false,                  // true = float to top
      "author": "Task Karate",
      "updatedAt": "2025-02-22T10:15:00Z"
    }]
  }

  NEWSLETTERS.JSON
  { "newsletters": [
    { "year": 2025, "month": 2, "file": "files/newsletters/2025-02.pdf" }
  ]}

  FILES THIS PAGE RELIES ON
  • /header.html + /assets/css/header.css   (shared header)
  • /footer.html + /assets/css/footer.css   (shared footer)
  • /assets/css/main.css                    (base layout, tokens, components)
  • /assets/css/news.css                    (this page’s extra styles)
  • /assets/js/partials.js                  (injects header & footer)
  • /assets/js/main.js                      (footer year, misc guards)

  ACCESSIBILITY
  • Skip link included.
  • Alt text pulled from heroAlt.
  • Buttons are <button> or clearly labeled links.

  =========================================================
-->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Task Karate – News & Archive</title>
  <meta name="description" content="Task Karate School updates, blog posts, and newsletter archive."/>
  <link rel="icon" href="TASK-NEW-LOGO.png"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet"/>

  <!-- SHARED STYLES (keep order) -->
  <link rel="stylesheet" href="assets/css/header.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/footer.css">
  <!-- PAGE STYLES -->
  <link rel="stylesheet" href="assets/css/news.css">
</head>
<body>
  <!-- Skip link for keyboard users -->
  <a class="skip-link" href="#page-start">Skip to content</a>

  <!-- Decorative background (styled in main.css) -->
  <div class="bg-geo" aria-hidden="true"></div>

  <!-- Shared header mounts here -->
  <div id="site-header"></div>

  <main id="page-start" class="container">
    <!-- ============= NEWSLETTER ARCHIVE ============= -->
    <section id="archive">
      <div class="card layered-soft">
        <span class="eyebrow">Newsletter Archive</span>
        <h1>Past Newsletters</h1>
        <p class="muted">Pick a year and month to download a PDF newsletter. If a month isn’t listed, we didn’t publish one (we were probably kicking pads).</p>

        <div class="archive-controls">
          <label for="yearSel" class="muted">Year</label>
          <select id="yearSel" aria-label="Select year"></select>

          <label for="monthSel" class="muted">Month</label>
          <select id="monthSel" aria-label="Select month"></select>

          <a id="dlBtn" class="btn navy square" href="#" target="_blank" rel="noopener" download>Download PDF</a>
          <span class="hint" id="noFile" hidden>No file for that selection.</span>
        </div>
      </div>
    </section>

    <!-- ================ BLOG / UPDATES ================ -->
    <section id="blog">
      <div class="card layered-off">
        <span class="eyebrow">Blog</span>
        <div class="blog-header">
          <h2>Updates from the dojo</h2>
          <div class="filters">
            <input id="search" type="search" placeholder="Search posts… (title, summary, body, tags)" aria-label="Search posts"/>
            <div id="tagRow" class="tag-row" role="group" aria-label="Filter by tag"></div>
          </div>
        </div>

        <!-- Post feed -->
        <div id="feed"></div>

        <!-- Load more -->
        <div class="loadmore-row">
          <button id="loadMore" class="btn steel square small" hidden>Load more</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer mounts here -->
  <div id="site-footer"></div>

  <!-- Scripts (order matters) -->
  <script src="assets/js/partials.js"></script>
  <script>mountPartials();</script>
  <script src="assets/js/main.js"></script>

  <!-- =================================================
       PAGE LOGIC (safe-ish Markdown, filters, archive)
       Keep this self-contained; no external libs needed.
       ================================================= -->
  <script>
  // ----------------- Mini helpers -----------------
  const qs  = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => [...el.querySelectorAll(s)];
  const months = ["January","February","March","April","May","June","July",
                  "August","September","October","November","December"];

  // Escape HTML before transforming Markdown
  const escapeHTML = (s='') => s
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');

  // Tiny Markdown → HTML (headings, bold, italics, links, lists, line breaks)
  function mdToHtml(md=''){
    // Safety: escape first
    let t = escapeHTML(md);

    // Code spans `code`
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Headings (## ..) — keep it simple
    t = t.replace(/^###\s?(.*)$/gm, '<h3>$1</h3>');
    t = t.replace(/^##\s?(.*)$/gm,  '<h2>$1</h2>');
    t = t.replace(/^#\s?(.*)$/gm,   '<h1>$1</h1>');

    // Bold **text** and italics *text*
    t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/\*([^*]+)\*/g,    '<em>$1</em>');

    // Links [label](url)
    t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

    // Unordered lists - item
    t = t.replace(/(?:^|\n)-(.*?)(?=\n|$)/g, (m, item)=>`<li>${item.trim()}</li>`);
    t = t.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');

    // Paragraphs: split on two newlines
    t = t.split(/\n{2,}/).map(block=>{
      if(/^\s*<(h1|h2|h3|ul|li|img|p|blockquote)/.test(block)) return block;
      return `<p>${block.replace(/\n/g,'<br>')}</p>`;
    }).join('\n');

    return t;
  }

  // Read/write filters in URL
  function readFiltersFromURL(){
    const p = new URLSearchParams(location.search);
    const q = (p.get('q')||'').trim();
    const tags = (p.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean);
    return { q, tags };
  }
  function writeFiltersToURL(q, tags){
    const p = new URLSearchParams(location.search);
    q ? p.set('q', q) : p.delete('q');
    tags?.length ? p.set('tags', tags.join(',')) : p.delete('tags');
    const url = `${location.pathname}?${p.toString()}${location.hash}`;
    history.replaceState(null, '', url);
  }

  // Fetch JSON (works locally; fails gracefully)
  async function loadJSON(path){
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw 0;
      return await r.json();
    }catch(e){
      console.warn('Could not fetch', path);
      return null;
    }
  }

  // ----------------- Archive UI -----------------
  async function initArchive(){
    const data = await loadJSON('data/newsletters.json') || {newsletters:[]};
    const years = [...new Set(data.newsletters.map(n=>n.year))].sort((a,b)=>b-a);
    const yearSel = qs('#yearSel');
    const monthSel = qs('#monthSel');
    const btn = qs('#dlBtn');
    const noFile = qs('#noFile');

    yearSel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    function refreshMonths(){
      const y = parseInt(yearSel.value,10);
      const monthsForYear = data.newsletters.filter(n=>n.year===y).map(n=>n.month).sort((a,b)=>a-b);
      monthSel.innerHTML = monthsForYear.map(m=>`<option value="${m}">${months[m-1]}</option>`).join('');
      updateLink();
    }
    function updateLink(){
      const y = parseInt(yearSel.value,10);
      const m = parseInt(monthSel.value,10);
      const rec = data.newsletters.find(n=>n.year===y && n.month===m);
      if(rec){
        btn.href = rec.file;
        btn.removeAttribute('aria-disabled');
        btn.removeAttribute('disabled');
        noFile.hidden = true;
      }else{
        btn.href = '#';
        btn.setAttribute('aria-disabled','true');
        btn.setAttribute('disabled','');
        noFile.hidden = false;
      }
    }
    yearSel.addEventListener('change', refreshMonths);
    monthSel.addEventListener('change', updateLink);
    if(years.length){ yearSel.value = years[0]; refreshMonths(); }
  }

  // ----------------- Blog UI -----------------
  const PAGE_SIZE = 8;
  let POSTS = {posts:[]};
  let activeTags = new Set();
  let queryText = '';
  let renderedCount = 0;

  function byPinnedThenDateDesc(a,b){
    if((b.pinned|0)!==(a.pinned|0)) return (b.pinned?1:0) - (a.pinned?1:0);
    return (a.date < b.date) ? 1 : -1;
  }
  function normalizePost(p){
    return {
      id: p.id,
      title: p.title || 'Untitled',
      date: p.date || '1970-01-01',
      tags: Array.isArray(p.tags) ? p.tags : [],
      hero: p.hero || '',
      heroAlt: p.heroAlt || '',
      summary: p.summary || '',
      bodyMd: p.bodyMd || '',
      bodyHtml: p.bodyHtml || '',
      draft: !!p.draft,
      pinned: !!p.pinned,
      author: p.author || 'Task Karate',
      updatedAt: p.updatedAt || ''
    };
  }
  function matchesFilters(p){
    // Drafts are hidden
    if(p.draft) return false;
    // Tag filter
    const tagsOK = !activeTags.size || p.tags.some(t=>activeTags.has(t));
    // Query filter
    const q = queryText.toLowerCase();
    const qOK = !q || [
      p.title, p.summary, p.bodyMd, p.bodyHtml, (p.tags||[]).join(' ')
    ].some(s => (s||'').toLowerCase().includes(q));
    return tagsOK && qOK;
  }

  function postCardHTML(p){
    const d = new Date(p.date+'T00:00:00');
    const when = isNaN(d) ? p.date : d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const tags = (p.tags||[]).map(t=>`<span class="pill">${t}</span>`).join(' ');
    // Prefer Markdown; fall back to provided HTML (already part of data)
    const body = p.bodyMd ? mdToHtml(p.bodyMd) : (p.bodyHtml || '');
    const summary = p.summary || '';
    return `
      <article id="${p.id}" class="post card">
        <h3 class="post-title">
          ${p.title}
          ${p.pinned?'<span class="pin" title="Pinned">📌</span>':''}
        </h3>
        <div class="meta"><span>${when}</span>${tags?`<span>•</span> ${tags}`:''}</div>
        ${p.hero ? `
          <div class="hero">
            <img src="${p.hero}" alt="${p.heroAlt ? p.heroAlt.replace(/"/g,'&quot;') : ''}" loading="lazy" decoding="async">
          </div>
        ` : ''}
        ${summary ? `<p class="summary">${summary}</p>` : ''}
        <div class="body" hidden>${body}</div>
        <button class="btn steel square small readmore" data-id="${p.id}" aria-expanded="false">Read more</button>
      </article>`;
  }

  function bindPostToggles(){
    qsa('.readmore').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const post = qs('#'+CSS.escape(id));
        const body = qs('.body', post);
        const open = body.hasAttribute('hidden') ? false : true;
        if(open){
          body.setAttribute('hidden','');
          btn.textContent = 'Read more';
          btn.setAttribute('aria-expanded','false');
        }else{
          body.removeAttribute('hidden');
          btn.textContent = 'Show less';
          btn.setAttribute('aria-expanded','true');
          // Update URL fragment
          history.replaceState(null,'','#'+id);
        }
      });
    });
  }

  function renderTagsRow(){
    const all = Array.from(new Set(POSTS.posts.flatMap(p=>p.tags||[]))).sort((a,b)=>a.localeCompare(b));
    qs('#tagRow').innerHTML = all.map(t=>`
      <button type="button" class="tag ${activeTags.has(t)?'active':''}" data-tag="${t}">${t}</button>
    `).join('');
    qs('#tagRow').addEventListener('click', (e)=>{
      const b = e.target.closest('.tag'); if(!b) return;
      const t = b.dataset.tag;
      if(activeTags.has(t)){ activeTags.delete(t); b.classList.remove('active'); }
      else { activeTags.add(t); b.classList.add('active'); }
      writeFiltersToURL(queryText, [...activeTags]);
      fullRender();
    }, { once:true }); // re-bound on fullRender
  }

  // Render feed with pagination
  function fullRender(){
    const list = POSTS.posts.map(normalizePost)
      .filter(matchesFilters)
      .sort(byPinnedThenDateDesc);

    const feed = qs('#feed');
    feed.innerHTML = '';
    renderedCount = 0;

    const toAdd = list.slice(0, PAGE_SIZE);
    feed.innerHTML = toAdd.map(postCardHTML).join('');
    renderedCount += toAdd.length;

    const more = qs('#loadMore');
    more.hidden = renderedCount >= list.length;
    more.onclick = () => {
      const next = list.slice(renderedCount, renderedCount+PAGE_SIZE);
      feed.insertAdjacentHTML('beforeend', next.map(postCardHTML).join(''));
      renderedCount += next.length;
      more.hidden = renderedCount >= list.length;
      bindPostToggles();
    };

    renderTagsRow();
    bindPostToggles();

    // Open permalinks (#post-id)
    const hash = location.hash.replace('#','').trim();
    if(hash){
      const el = qs('#'+CSS.escape(hash));
      if(el){
        const body = qs('.body', el);
        const btn  = qs('.readmore', el);
        if(body && btn){ body.removeAttribute('hidden'); btn.textContent='Show less'; btn.setAttribute('aria-expanded','true'); }
        el.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }
  }

  async function initBlog(){
    const p = await loadJSON('data/posts.json') || {posts:[]};
    POSTS = p;

    // Seed filters from URL
    const urlFilters = readFiltersFromURL();
    queryText = urlFilters.q || '';
    activeTags = new Set(urlFilters.tags || []);
    qs('#search').value = queryText;

    // Bind search
    qs('#search').addEventListener('input', (e)=>{
      queryText = (e.target.value||'').trim();
      writeFiltersToURL(queryText, [...activeTags]);
      fullRender();
    });

    fullRender();
  }

  // Init both sections
  (async function init(){
    await initArchive();
    await initBlog();
  })();
  </script>
</body>
</html>
